var DramaType,__awaiter=this&&this.__awaiter||function(e,n,o,c){return new(o=o||Promise)(function(a,t){function s(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?a(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(s,r)}i((c=c.apply(e,n||[])).next())})};import KeyAnimation from"../animation/KeyAnimation.js";import assert from"../assert/assert.js";import LocalStorageApi,{StorageType}from"../localStorage/LocalStorageApi.js";import Message,{processMessage}from"../message/Message.js";import MessageID from"../message/MessageID.js";import Setting from"../setting/Setting.js";(e=>{e.Ball="Ball",e.Function="Function",e.Image="Image",e.Code="Code",e.Answer="Answer",e.NEXT_PART="NextPart"})(DramaType=DramaType||{});class Drama{static click(){return __awaiter(this,void 0,void 0,function*(){KeyAnimation.continue&&(yield processMessage(),KeyAnimation.autoPlay)&&(yield this.click())})}static refresh(t){for(var[e,a]of Drama.replaceTypes)if(t.type===e){assert(null!==t.originalMessage);let e=t.originalMessage;for(var[s,r]of a)e=e.replace(s(),r());t.obj=e;break}return t}static clickOnceContains(e){return Drama.clickType.includes(e.type)}static processToNextClickOnce(){this.processWithFilter(e=>!Drama.clickOnceContains(e))}static processWithFilter(e){return __awaiter(this,void 0,void 0,function*(){for(;e(Drama.getCurrentMessage());)LocalStorageApi.write(StorageType.MESSAGE_COUNT,MessageID.getID()),yield Drama.processMessage(Drama.getCurrentMessage()),MessageID.addOne()})}static getLastMessageIndex(t,a){for(let e=t;0<=e;e--)if(a(Drama.getMessageByID(e)))return e;throw new Error("No message found.")}static createNewTextLine(){var e=document.createElement("div");return e.id="question-title",e.style.width="auto",document.getElementById("left").appendChild(e),e}static findMessageID(t,a,s){if(0===Message.messages.length)throw new Error("Message.messages is empty");for(let e=0;e<Message.messages.length;e++){var r=Drama.getMessageByID(e);if(!(void 0!==t&&r.type!==t||"string"==typeof a&&"string"==typeof r.obj&&!r.obj.includes(a)||"function"==typeof a&&"function"==typeof r.obj&&a.name!==r.obj.name||void 0!==a&&"string"!=typeof a&&"function"!=typeof a&&r.obj!==a||void 0!==s&&r.originalMessage!==s))return e}throw new Error("Message not found")}static processMessage(e){return __awaiter(this,void 0,void 0,function*(){if(e.type===DramaType.Ball)yield KeyAnimation.setObjAnimation(e.obj,Drama.createNewTextLine());else{if(e.type!==DramaType.Code&&e.type!==DramaType.Function)throw new Error("Unknown type : "+e.type);yield e.obj()}})}static getMessageByID(e){return Message.messages[e]}static getCurrentMessage(){return Drama.getMessageByID(MessageID.getID())}}Drama.replaceTypes=new Map([[DramaType.Ball,new Map([[()=>Setting.drama_time,()=>Message.getHelloMsg()]])]]),Drama.clickType=[DramaType.Code,DramaType.Ball];export default Drama;export{DramaType};