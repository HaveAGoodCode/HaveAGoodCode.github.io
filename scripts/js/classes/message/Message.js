var __awaiter=this&&this.__awaiter||function(e,i,s,c){return new(s=s||Promise)(function(a,t){function n(e){try{o(c.next(e))}catch(e){t(e)}}function r(e){try{o(c.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?a(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(n,r)}o((c=c.apply(e,i||[])).next())})};import Setting from"../setting/Setting.js";import KeyAnimation from"../animation/KeyAnimation.js";import MessageID from"../message/MessageID.js";import CodeFrame from"../code_frame/code.js";import Codes from"../../Codes.js";import Question from"../textbook/Question.js";import Drama,{DramaType}from"../drama/Dramas.js";import LocalStorageApi,{StorageType}from"../localStorage/LocalStorageApi.js";import Qst from"../textbook/qst.js";class Message{static initialize(){return __awaiter(this,void 0,void 0,function*(){try{var e=yield fetch(Setting.fineSentenceAPI);Message.goodMessage=yield e.text()}catch(e){console.error(e)}})}constructor(e,t,a=null){if(e===DramaType.Ball&&null===a)throw new Error("OriginalMessage cannot be null when type is Ball!");this.originalMessage=a,this.type=e,this.obj=t}static createObjWithString(e){for(var t of Object.values(DramaType)){var a="@"+t+":";if(e.startsWith(a))return Message.processType(t,e.replace(a,""))}throw new Error("Unknown type : "+e)}static processType(t,a){switch(t){case DramaType.Ball:var e=a.replace(Setting.drama_fineSentence,Message.goodMessage);return new Message(t,e,e);case DramaType.Function:{var n,r=a.replace(/[();]/g,""),o={Question:Question,Qst:Qst};let e=null;for(n in o){var i=o[n];if(i&&"function"==typeof(e=i[r]))break}if("function"!=typeof e)throw new Error("Unknown function: "+r);return new Message(t,e)}case DramaType.Image:{let e=document.createElement("img");return e.src=Setting.imageSrcFolder+a,new Message(DramaType.Function,()=>document.getElementById("left").appendChild(e))}case DramaType.Code:{let e=CodeFrame.createCodeFrame(Codes[a]);return new Message(DramaType.Code,()=>document.getElementById("left").appendChild(e))}case DramaType.Answer:return new Message(DramaType.Function,()=>Question.answer=a);default:throw new Error(`Unknown type : ${t}, string : `+a)}}static getHelloMsg(){var e=(new Date).getHours();return 4<=e&&e<12?Setting.goodMorning:12<=e&&e<18?Setting.goodAfterNoon:Setting.goodNight}}Message.messages=[];export default Message;function createNewTextLine(){var e=document.createElement("div");return e.id="question-title",e.style.width="auto",document.getElementById("left").appendChild(e),e}function processMessage(){return __awaiter(this,void 0,void 0,function*(){LocalStorageApi.write(StorageType.MESSAGE_COUNT,MessageID.getID());var e=Drama.refresh(Message.messages[MessageID.getID()]),t=Drama.clickOnceContains(MessageID.addOneAndGet())?void 0:()=>__awaiter(this,void 0,void 0,function*(){return yield processMessage()});if(e.type===DramaType.Ball)yield KeyAnimation.setObjAnimation(e.obj,createNewTextLine(),t);else if(e.type===DramaType.Code)KeyAnimation.setObjAnimation2(e.obj,t);else{if(e.type!==DramaType.Function)throw new Error("Unknown type : "+e.type);yield e.obj(),yield null==t?void 0:t()}})}export{createNewTextLine,processMessage};