var __awaiter=this&&this.__awaiter||function(e,o,i,c){return new(i=i||Promise)(function(a,t){function r(e){try{n(c.next(e))}catch(e){t(e)}}function s(e){try{n(c.throw(e))}catch(e){t(e)}}function n(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(r,s)}n((c=c.apply(e,o||[])).next())})};import Setting from"../setting/Setting.js";import MessageID from"../message/MessageID.js";import CodeFrame from"../code_frame/code.js";import Codes from"../../Codes.js";import Question from"../textbook/Question.js";import Drama,{DramaType}from"../drama/Dramas.js";import LocalStorageApi,{StorageType}from"../localStorage/LocalStorageApi.js";import Qst from"../textbook/qst.js";class Message{static initialize(){return __awaiter(this,void 0,void 0,function*(){try{var e=yield fetch(Setting.fineSentenceAPI);Message.goodMessage=yield e.text()}catch(e){console.error(e)}})}constructor(e,t,a=null){if(e===DramaType.Ball&&null===a)throw new Error("OriginalMessage cannot be null when type is Ball!");this.originalMessage=a,this.type=e,this.obj=t}static createObjWithString(e){for(var t of Object.values(DramaType).filter(e=>e!==DramaType.Ball)){var a="@"+t+":";if(e.startsWith(a))return Message.processType(t,e.replace(a,""))}var r;if(!e.startsWith("@")||e.startsWith("@Ball:"))return r="@"+DramaType.Ball+":",Message.processType(DramaType.Ball,e.replace(r,""));throw new Error("Unknown type : "+e)}static processType(t,a){switch(t){case DramaType.Ball:var e=a.replace(Setting.drama_fineSentence,Message.goodMessage);return new Message(t,e,e);case DramaType.Function:{var r,s=a.replace(/[();]/g,""),n={Question:Question,Qst:Qst};let e=null;for(r in n){var o=n[r];if(o&&"function"==typeof(e=o[s]))break}if("function"!=typeof e)throw new Error("Unknown function: "+s);return new Message(t,e)}case DramaType.Image:{let e=document.createElement("img");return e.src=Setting.imageSrcFolder+a,new Message(DramaType.Function,()=>document.getElementById("left").appendChild(e))}case DramaType.Code:{let e=CodeFrame.createCodeFrame(Codes[a]);return new Message(DramaType.Code,()=>document.getElementById("left").appendChild(e))}case DramaType.Answer:return new Message(DramaType.Function,()=>Question.answer=a);default:throw new Error(`Unknown type : ${t}, string : `+a)}}static getHelloMsg(){var e=(new Date).getHours();return 4<=e&&e<12?Setting.goodMorning:12<=e&&e<18?Setting.goodAfterNoon:Setting.goodNight}}Message.messages=[];export default Message;function processMessage(){return __awaiter(this,void 0,void 0,function*(){LocalStorageApi.write(StorageType.MESSAGE_COUNT,MessageID.getID()),yield Drama.processMessage(Drama.getCurrentMessage()),MessageID.addOne(),Drama.clickOnceContains(Drama.getCurrentMessage())||(yield processMessage())})}export{processMessage};