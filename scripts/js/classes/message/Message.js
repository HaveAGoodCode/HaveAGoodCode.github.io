var __awaiter=this&&this.__awaiter||function(e,o,i,g){return new(i=i||Promise)(function(a,t){function s(e){try{r(g.next(e))}catch(e){t(e)}}function n(e){try{r(g.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(s,n)}r((g=g.apply(e,o||[])).next())})};import{DramaType,classList}from"../enum/Types.js";import Setting from"../setting/Setting.js";import{goodMessage}from"../constants/Constants.js";import KeyAnimation from"../animation/KeyAnimation.js";import MessageID from"../message/MessageID.js";import{messages}from"../constants/Constants.js";import Doc from"../doct/doct.js";export default class Message{constructor(e,t,a=null){if(e===DramaType.Ball&&null===a)throw new Error("OriginalMessage cannot be null when type is Ball!");this.originalMessage=a,this.type=e,this.obj=t}static createObjWithString(e){for(var t of Object.values(DramaType)){var a="@"+t+":";if(e.startsWith(a))return Message.processType(t,e.replace(a,""))}throw new Error("Unknow type : "+e)}static processType(e,t){switch(e){case DramaType.Ball:var a=t.replace(Setting.drama_fineSentence,goodMessage);return new Message(e,a,a);case DramaType.Function:var s,n=t.replace(/[();]/g,""),r=null;for(s in classList){var o=classList[s];if(o&&"function"==typeof(r=o[n]))break}if("function"!=typeof r)throw new Error(`Unknow function : ${r}, name : `+n);return new Message(e,r);case DramaType.Image:a=document.createElement("img");return a.src=Setting.imageSrcFolder+t,a.classList.add(Setting.stableSizeTag),new Message(e,a);default:throw new Error(`Unknow type : ${e}, string : `+t)}}static getHelloMsg(){var e=(new Date).getHours();return 4<=e&&e<12?Setting.goodMorning:12<=e&&e<18?Setting.goodAfterNoon:Setting.goodNight}}let ballSays=Doc.getElementById(Setting.ballSaysID);function processMessage(){return __awaiter(this,void 0,void 0,function*(){var e=messages[MessageID.getID()];switch(e.type){case DramaType.Ball:MessageID.addOne();var t=messages[MessageID.getID()].type!==DramaType.Ball?()=>__awaiter(this,void 0,void 0,function*(){yield processMessage()}):null;return void KeyAnimation.setObjAnimation(e.obj,ballSays,t);case DramaType.Function:yield e.obj();break;default:throw new Error("Unknow type : "+e.type)}return MessageID.addOne(),messages[MessageID.getID()].type!==DramaType.Ball&&(yield processMessage()),MessageID.getID()})}export{ballSays,processMessage};